<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FOTA Direct Uploader</title>
<style>
  :root{--bg:#060912;--panel:#0b1020;--fg:#eaf2ff;--bd:#1a2340;--a:#00e0ff;--b:#7cffb2}
  *{box-sizing:border-box}body{margin:0;min-height:100vh;display:grid;place-items:center;background:
  radial-gradient(900px 600px at 75% -10%, rgba(0,224,255,.12), transparent 60%),
  radial-gradient(700px 500px at 10% 110%, rgba(124,255,178,.08), transparent 60%),var(--bg);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--fg);padding:24px}
  .card{width:min(860px,100%);background:linear-gradient(180deg,rgba(255,255,255,.03),transparent),var(--panel);
  border:1px solid var(--bd);border-radius:20px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.45);backdrop-filter:blur(6px)}
  h1{margin:0 0 10px;font-size:22px}
  .row{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;margin:8px 0}
  .txt{display:flex;flex-direction:column;gap:8px}
  input[type="text"]{background:#0c1428;border:1px solid var(--bd);border-radius:12px;color:var(--fg);padding:12px;font-size:15px}
  input[type="text"]:focus{border-color:var(--a)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:10px 14px;border-radius:999px;border:1px solid var(--bd);background:#0b1326;cursor:pointer;color:#bcd3ff;font-size:13px}
  .chip.active{border-color:transparent;color:#071226;background:linear-gradient(90deg,var(--a),var(--b));font-weight:800}
  .pill{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;border:1px solid var(--bd);background:#0c1428}
  .btn{padding:11px 14px;border-radius:10px;border:1px solid var(--bd);background:#0e1830;color:#eaf2ff;cursor:pointer}
  .btn.primary{border:0;background:linear-gradient(90deg,var(--a),var(--b));color:#071226;font-weight:800}
  .hint{color:#8aa0c9;font-size:12px}
</style>
<body>
<div class="card">
  <h1>FOTA Direct Uploader</h1>

  <form id="f" method="post" enctype="multipart/form-data">
    <div class="row">
      <label class="txt">Raspberry Pi IP
        <input id="ip" type="text" placeholder="192.168.137.187" required />
      </label>
      <label class="txt">Version (ZIP)
        <input id="version" name="version" type="text" placeholder="1.4.0" />
      </label>
    </div>

    <div class="row">
      <div class="txt">
        <div>Mode</div>
        <div class="chips" id="modes">
          <div class="chip active" data-mode="single">Single</div>
          <div class="chip" data-mode="zip">ZIP</div>
        </div>
        <input type="hidden" id="mode" name="mode" value="single" />
      </div>

      <div class="txt">
        <div>File</div>
        <div class="pill">
          <input id="file" name="file" type="file" accept=".py,.zip" required />
          <button type="button" class="btn" id="clearBtn">Clear</button>
        </div>
        <div id="hint" class="hint">&nbsp;</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
      <button type="button" class="btn" id="openBtn">Open Endpoint</button>
      <button type="submit" class="btn primary">Upload</button>
    </div>
  </form>

  <pre id="out" style="display:none;margin-top:12px;background:#081025;border:1px solid var(--bd);padding:12px;border-radius:12px;max-height:260px;overflow:auto"></pre>
</div>

<script>
  const $=id=>document.getElementById(id);
  const modes=modes, mode=mode, fileEl=file, ver=version, ip=ip, hint=hint, out=out;

  // mode chips
  modes.addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    modes.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); mode.value=c.dataset.mode;
  });

  // file info + auto mode/version
  fileEl.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f){ hint.textContent=''; return; }
    const isZip=/\.zip$/i.test(f.name);
    // auto mode
    if(isZip && mode.value!=='zip'){ mode.value='zip'; modes.children[0].classList.remove('active'); modes.children[1].classList.add('active'); }
    if(!isZip && mode.value!=='single'){ mode.value='single'; modes.children[1].classList.remove('active'); modes.children[0].classList.add('active'); }
    // auto version
    const m=f.name.match(/(\d+\.\d+\.\d+)/); if(m && !ver.value) ver.value=m[1];
    hint.textContent = (isZip?'ZIP':'Single') + ' · ' + f.name + ' · ' + Math.round(f.size/1024) + ' KB';
  });

  // clear
  clearBtn.onclick=()=>{ fileEl.value=''; hint.textContent=''; };

  // open endpoint
  openBtn.onclick=()=>{
    const host=ip.value.trim(); if(!host){ alert('IP'); return; }
    window.open('http://'+host+':8080/upload','_blank');
  };

  // submit: set action to Pi and let browser POST directly (no fetch/XHR, CORS-free)
  f.addEventListener('submit', e=>{
    const host=ip.value.trim();
    if(!host){ e.preventDefault(); alert('IP'); return; }
    e.target.action = 'http://'+host+':8080/upload';
    out.style.display='block'; out.textContent='Uploading to '+e.target.action+' ...';
    // 브라우저가 직접 Pi로 POST → Pi의 JSON이 새 페이지로 표시됨
  });
</script>
